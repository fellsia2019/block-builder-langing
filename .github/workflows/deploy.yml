name: Deploy Block Builder Landing

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PROJECT_DIR: .

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t block-builder-landing:${{ github.sha }} -t block-builder-landing:latest -f Dockerfile .

      - name: Save Docker image to tar
        run: |
          docker save block-builder-landing:latest -o image.tar
          gzip image.tar
          ls -lh image.tar.gz
          pwd

      - name: Prepare files for deployment
        run: |
          mkdir -p deploy-temp
          
          # Copy necessary files
          cp -r public deploy-temp/ || true
          cp package.json deploy-temp/ || true
          cp package-lock.json deploy-temp/ || true
          cp next.config.js deploy-temp/ || true
          cp docker-compose.prod.yml deploy-temp/ || true
          [ -f .dockerignore ] && cp .dockerignore deploy-temp/ || true
          
          # List copied files for debugging
          echo "Files in deploy-temp:"
          ls -la deploy-temp/
          
          chmod -R 755 deploy-temp

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.VDS_SSH_KEY }}
          port: ${{ secrets.VDS_SSH_PORT || 22 }}
          source: "deploy-temp/*"
          target: "/opt/landing"
          overwrite: true

      - name: Upload Docker image to server
        run: |
          echo "${{ secrets.VDS_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -p ${{ secrets.VDS_SSH_PORT || 22 }} \
              -i /tmp/deploy_key \
              ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} \
              "mkdir -p /opt/landing"
          
          scp -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -P ${{ secrets.VDS_SSH_PORT || 22 }} \
              -i /tmp/deploy_key \
              image.tar.gz \
              ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }}:/opt/landing/
          
          rm -f /tmp/deploy_key

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.VDS_SSH_KEY }}
          port: ${{ secrets.VDS_SSH_PORT || 22 }}
          script: |
            set -e
            cd /opt/landing
            
            # Move files from deploy-temp if exists
            if [ -d deploy-temp ]; then
              echo "üì¶ Moving files from deploy-temp..."
              mv deploy-temp/* . 2>/dev/null || true
              mv deploy-temp/.* . 2>/dev/null || true
              rmdir deploy-temp 2>/dev/null || true
              echo "‚úÖ Files moved"
            fi
            
            # Load Docker image
            echo "üì¶ Loading Docker image..."
            if [ -f image.tar.gz ]; then
              gunzip -c image.tar.gz | docker load
              rm -f image.tar.gz
            else
              echo "‚ö†Ô∏è  image.tar.gz not found, skipping image load"
            fi
            
            # Detect docker compose command
            if docker compose version > /dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            elif docker-compose --version > /dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker-compose"
            else
              echo "‚ùå Neither 'docker compose' nor 'docker-compose' found!"
              exit 1
            fi
            
            echo "üì¶ Using: $DOCKER_COMPOSE_CMD"
            
            # Create shared network if not exists
            docker network create bb-shared-network || true
            
            # Stop and remove existing containers
            echo "üõë Stopping existing containers..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml down || true
            
            # Remove container by name if exists (in case it wasn't managed by compose)
            docker rm -f bb-landing-prod 2>/dev/null || true
            
            # Start services
            echo "üöÄ Starting services..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml up -d
            
            # Cleanup
            echo "üßπ Cleaning up old images..."
            docker image prune -f || true
            
            # Wait for health check
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 15
            
            # Show status
            echo "üìä Service status:"
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps

      - name: Cleanup
        if: always()
        run: |
          rm -f image.tar.gz
          rm -rf deploy-temp

